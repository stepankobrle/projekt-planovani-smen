// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- GLOBÁLNÍ NASTAVENÍ SYSTÉMU ---
model OrganizationSettings {
  id                   Int     @id @default(1)
  workOnWeekends       Boolean @default(false)
  workOnHolidays       Boolean @default(false)
  minRestBetweenShifts Int     @default(11) // Zákonný odpočinek v hodinách
}

// --- ČÍSELNÍKY A STRUKTURA ---
model Location {
  id           Int                   @id @default(autoincrement())
  name         String
  address      String?
  profiles     Profile[]
  shifts       Shift[]
  requirements StaffingRequirement[]
  createdAt    DateTime              @default(now())
  notifications Notification[]
  scheduleGroups ScheduleGroup[]
}

model JobPosition {
  id           Int                   @id @default(autoincrement())
  name         String
  isManagerial Boolean               @default(false)
  profiles     Profile[]
  requirements StaffingRequirement[]
  shifts Shift[]

}

model ShiftType {
  id           Int                   @id @default(autoincrement())
  name         String                // např. "Ranní", "Odpolední", "Vlastní"
  startTime    String?               // Formát "HH:mm", null pro flexibilní směny
  endTime      String?
  colorCode    String                @default("#3b82f6")
  shifts       Shift[]
  requirements StaffingRequirement[]
  availabilities Availability[]      // Vazba pro preference konkrétních směn
}

// --- UŽIVATELÉ ---
model Profile {
  id                 String         @id @default(uuid())
  email              String         @unique
  password           String?
  fullName           String
  role               UserRole       @default(EMPLOYEE)
  targetHoursPerMonth Decimal        @default(160) // Fond hodin pro plný úvazek
  
  invitationToken    String?        @unique
  invitationExpires  DateTime?
  isActivated        Boolean        @default(false)

  locationId         Int?
  location           Location?      @relation(fields: [locationId], references: [id])

  jobPositionId         Int?
  jobPosition           JobPosition?   @relation(fields: [jobPositionId], references: [id])
  
  availabilities     Availability[]
  assignedShifts     Shift[]
  createdAt          DateTime       @default(now())
  submissions    ScheduleSubmission[]

vacationRequests      VacationRequest[]
  receivedNotifications Notification[] @relation("ReceivedNotifications")
}


model VacationRequest {
  id        String   @id @default(uuid())
  userId    String
  user      Profile  @relation(fields: [userId], references: [id])
  
  startDate DateTime
  endDate   DateTime
  type      String   @default("VACATION") 
  status    String   @default("PENDING") 
  
  note      String? 
  createdAt DateTime @default(now())
}


model Notification {
  id        String   @id @default(uuid())
  content   String   
  isRead    Boolean  @default(false)
  type      String   // ALERT, INFO, VACATION_REQUEST
  createdAt DateTime @default(now())

  locationId Int
  location   Location @relation(fields: [locationId], references: [id])

  recipientId String
  recipient   Profile @relation("ReceivedNotifications", fields: [recipientId], references: [id])
}


// --- PLÁNOVÁNÍ: POTŘEBA OBSAZENÍ (DRAFTY) ---
model StaffingRequirement {
  id            Int         @id @default(autoincrement())
  date          DateTime?   // Konkrétní den pro mimořádné směny
  dayOfWeek     Int?        // 0-6 (0=Neděle) pro opakující se šablony týdne
  
  // Definice slotů na směně
  countFullTime Int         @default(0) // Kolik chceme HPP zaměstnanců
  countPartTime Int         @default(0) // Kolik chceme brigádníků
  countAny      Int         @default(0) // Je jedno, kdo tam půjde (priorita HPP pak DPP)
  
  locationId    Int
  location      Location    @relation(fields: [locationId], references: [id])
  
  shiftTypeId   Int
  shiftType     ShiftType   @relation(fields: [shiftTypeId], references: [id])
  
  positionId    Int
  position      JobPosition @relation(fields: [positionId], references: [id])
}

// --- REALIZOVANÉ SMĚNY ---
model Shift {
  id             String      @id @default(uuid())
  startDatetime  DateTime
  endDatetime    DateTime
  status         ShiftStatus @default(DRAFT)
  availabilities  Availability[]

  locationId     Int
  location       Location    @relation(fields: [locationId], references: [id])

  shiftTypeId    Int?
  shiftType      ShiftType?  @relation(fields: [shiftTypeId], references: [id])

  // Prázdné před přiřazením algoritmem nebo výběrem brigádníka
  assignedUserId String?
  assignedUser   Profile?    @relation(fields: [assignedUserId], references: [id])

  createdAt      DateTime    @default(now())

  scheduleGroupId String?
  scheduleGroup   ScheduleGroup? @relation(fields: [scheduleGroupId], references: [id])

  isMarketplace Boolean @default(false)

  jobPositionId      Int
  jobPosition        JobPosition    @relation(fields: [jobPositionId], references: [id])

}

model ScheduleGroup {
  id           String         @id @default(uuid())
  name         String?        // Teď už může být volitelné, název se generuje z měsíce
  year         Int      
  month        Int      
  locationId   Int
  calendarDays String[]       // Např. ["2026-02-01", "2026-02-02", ...]
  status       ScheduleStatus @default(DRAFT)
  

  shifts       Shift[]
  location   Location       @relation(fields: [locationId], references: [id]) 

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt // Automaticky aktualizuje čas při změně

  @@unique([locationId, year, month])
}

// --- DOSTUPNOST A PREFERENCE ZAMĚSTNANCŮ ---
model Availability {
  id            String           @id @default(uuid())
  startDatetime DateTime         // Kdy preference začíná (pro flexibilitu v rámci dne)
  endDatetime   DateTime         // Kdy preference končí
  type          AvailabilityType @default(AVAILABLE)

  shiftId       String?          
  shift         Shift?           @relation(fields: [shiftId], references: [id])

  // Pokud si vybírají "chci ranní", propojí se to zde:
  shiftTypeId   Int?             
  shiftType     ShiftType?       @relation(fields: [shiftTypeId], references: [id])

  userId        String
  user          Profile          @relation(fields: [userId], references: [id])

  createdAt     DateTime         @default(now())
}

model ScheduleSubmission {
  id          String   @id @default(uuid())
  weekNumber  Int      // Např. 7
  year        Int      // Např. 2026
  submittedAt DateTime @default(now())
  
  userId      String
  user        Profile  @relation(fields: [userId], references: [id])

  @@unique([userId, weekNumber, year]) // Jeden uživatel potvrdí jeden týden jen jednou
}


// --- ENUMERACE ---
enum UserRole {
  ADMIN
  MANAGER
  EMPLOYEE    // Plný úvazek (HPP)
  PART_TIMER  // Brigádník (DPP/DPČ)
}

enum ScheduleStatus {
  DRAFT
  PREFERENCES   // Probíhá sběr dat od lidí
  GENERATED     // Algoritmus proběhl, admin ladí
  PUBLISHED     // Finální verze pro všechny
}

enum ShiftStatus {
  DRAFT
  OFFERED
  PREFERENCES
  GENERATED     
  PUBLISHED     
}

enum AvailabilityType {
  AVAILABLE
  UNAVAILABLE
  PREFERRED   // Chci tuhle směnu/čas
}